<app-modal type="loading" *ngIf="isFetching"></app-modal>

<div class="row" #elseDiv>
    <div class="col-sm-10 row pt-3 ps-5">
        <div class="col-sm-6">
            <h1>{{ season?.name}}
                <span *ngIf="season!.isArchived" class="gold-tag">archived</span>
            </h1>
            <p>Created on {{ this.createdAt }}</p>
            <button class="btn btn-primary btn-sm" (mouseup)="onFetchData()">Refresh</button>
        </div>
    <div class="col-sm-6">
            <select class="form-select" [formControl]="selectType">
                <option value="drivers">Drivers</option>
                <option value="teams">Teams</option>
                <option value="races">Races</option>
            </select>

            <select class="form-select mt-3" [formControl]="selectValue">
                <option value="all" [selected]="true">All</option>

                <ng-template [ngIf]="selectType.value === 'drivers'">
                    <option *ngFor="let option of season?.drivers" [value]="option.id">{{ option.name }}</option>
                </ng-template>

                <ng-template [ngIf]="selectType.value === 'teams'">
                    <option *ngFor="let option of season?.teams" [value]="option.id">{{ option.name }}</option>
                </ng-template>

                <ng-template [ngIf]="selectType.value === 'races'">
                    <option *ngFor="let option of season?.races" [value]="option.id">{{ option.name }}</option>
                </ng-template>
            </select>
        </div>

        <div [ngSwitch]="selectType.value" class="row">
            <div *ngSwitchCase="'drivers'">
                <div *ngIf="selectValue.value === 'all'; else elseDiv">
                    <app-driver-all
                        [isLoggedIn]="isLoggedIn"
                        [season]="season!"
                        [driverAll]="getDriverAll()"
                        (onFetchDataEmitter)="onFetchData()"
                    ></app-driver-all>
                </div>
                <ng-template #elseDiv>
                    <app-driver-result
                        [isLoggedIn]="isLoggedIn"
                        [season]="season!"
                        [driverResults]="getDriverById(selectValue.value)"
                        [driverId]="selectValue.value"
                        (onFetchDataEmitter)="onFetchData()"
                    ></app-driver-result>
                </ng-template>
            </div>
            <div *ngSwitchCase="'teams'">
                <div *ngIf="selectValue.value === 'all'; else elseDiv">
                    <app-team-all
                        [isLoggedIn]="isLoggedIn"
                        [season]="season!"
                        [teamAll]="getTeamAll()"
                        (onFetchDataEmitter)="onFetchData()"
                    ></app-team-all>
                </div>
                <ng-template #elseDiv>
                    <app-team-result
                        [teamResults]="getTeamById(selectValue.value)"
                    ></app-team-result>
                </ng-template>
            </div>
            <div *ngSwitchCase="'races'">
                <div *ngIf="selectValue.value === 'all'; else elseDiv">
                    <app-race-all
                        [isLoggedIn]="isLoggedIn"
                        [season]="season!"
                        [raceAll]="getRaceAll()"
                        (onFetchDataEmitter)="onFetchData()"
                    ></app-race-all>
                </div>
                <ng-template #elseDiv>
                    <app-race-result
                        [isLoggedIn]="isLoggedIn"
                        [season]="season!"
                        [raceResults]="getRaceById(selectValue.value)"
                        [raceId]="selectValue.value"
                        (onFetchDataEmitter)="onFetchData()"
                    ></app-race-result>
                </ng-template>
            </div>
        </div>
    </div>
    <div class="col-sm-2">
        <div *ngIf="this.isLoggedIn && getUserPermission()?.type === 1" class="d-grid gap-2 mt-3">
            <div class="btn btn-outline-primary btn-sm btn-block" (mouseup)="openModal('updateSeason')" *ngIf="!season!.isArchived">Edit</div>
            <div class="btn btn-outline-primary btn-sm btn-block" (mouseup)="archiveSeason()">{{ season!.isArchived ? 'Unarchive' : 'Archive' }}</div>
            <div class="btn btn-outline-danger btn-sm btn-block" (mouseup)="openModal('deleteSeason')" *ngIf="!season!.isArchived">Delete</div>
        </div>

        <h2 class="mt-3">Moderators</h2>
        <div *ngFor="let permission of getPermissions()" class="mb-2">
            <div>
                <button *ngIf="this.isLoggedIn && getUserPermission()?.type === 1 && permission.type === 0 && !season!.isArchived"
                    class="btn btn-danger btn-sm d-inline-flex me-1" (mouseup)="deletePermission(permission.id)">
                    <i class="bi bi-x-lg"></i>
                </button>
                <button *ngIf="this.isLoggedIn && getUserPermission()?.type === 1 && permission.type === 0 && !season!.isArchived"
                    class="btn btn-primary btn-sm d-inline-flex me-1" (mouseup)="updatePermission(permission.id)">
                    <i class="bi bi-chevron-up"></i>
                </button>
                <div *ngIf="permission.type === 1" class="btn btn-warning btn-sm d-inline-flex me-1 disabled">
                    <i class="bi bi-shield-fill"></i>
                </div>
                <div class="d-inline-flex me-1"
                    [ngClass]="this.user?.username === permission.username ? 'fw-bold' : ''">
                    {{ permission.username }}
                </div>
            </div>
        </div>

        <hr>

        <h2>Description</h2>
        <p>{{ season?.description }}</p>
    </div>
</div>

<app-modal type="form" *ngIf="modal === 'updateSeason'">
    <app-season-form
        [selectedSeason]="season"
        (onCloseModalEmitter)="closeModal()"
        (onFetchDataEmitter)="onFetchData()"
    ></app-season-form>
</app-modal>

<app-modal type="form" *ngIf="modal === 'deleteSeason'">
    <h1>Delete "{{ season?.name }}" season</h1>
    <p>Are you sure?</p>
    <form #postForm="ngForm" (ngSubmit)="deleteSeason()">
        <div class="row d-flex">
            <div class="col-6">
                <button class="btn btn-outline-primary btn-sm btn-block" (mouseup)="closeModal()">Cancel</button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger btn-sm btn-block">Delete</button>
            </div>
        </div>
    </form>

    <div class="alert alert-danger mt-3" role="alert" *ngIf="error">
        {{error}}
    </div>
</app-modal>
